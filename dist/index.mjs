import S from"cross-spawn";import l from"fs-extra";import y from"path";import T from"p-limit";import{request as $}from"undici";var x=Object.defineProperty,U=(f,u,e)=>u in f?x(f,u,{enumerable:!0,configurable:!0,writable:!0,value:e}):f[u]=e,A=(f,u,e)=>(U(f,typeof u!="symbol"?u+"":u,e),e);class v{constructor(){A(this,"links"),A(this,"totalDuration"),A(this,"downloadMethod","undici"),A(this,"encryptionInfo"),this.links=[],this.totalDuration=0}parseM3U8Content(u){const e=u.split(`
`).map(n=>n.trim()).filter(n=>n);let t=0;console.log(`\u{1F3AC} \u5F00\u59CB\u89E3\u6790 M3U8 \u6587\u4EF6...
`);for(let n=0;n<e.length;n++){const o=e[n];if(o.startsWith("#EXT-X-KEY:"))this.parseEncryptionInfo(o);else if(o.startsWith("#EXTINF:")){const r=o.match(/#EXTINF:([\d.]+)/);r&&(t=parseFloat(r[1]))}else!o.startsWith("#")&&o.includes("http")&&(this.links.push({index:this.links.length+1,url:o,duration:t}),this.totalDuration+=t,t=0)}return this.links}parseEncryptionInfo(u){const e=u.match(/METHOD=([^,]+)/),t=u.match(/URI="([^"]+)"/),n=u.match(/IV=0x([a-fA-F0-9]+)/);e&&(this.encryptionInfo={method:e[1],keyUrl:t?t[1]:void 0,iv:n?n[1]:void 0},console.log(`\u{1F510} \u68C0\u6D4B\u5230\u52A0\u5BC6: ${this.encryptionInfo.method}`),this.encryptionInfo.keyUrl&&console.log(`\u{1F511} \u5BC6\u94A5URL: ${this.encryptionInfo.keyUrl}`),this.encryptionInfo.iv&&console.log(`\u{1F522} IV: ${this.encryptionInfo.iv}`))}async downloadDecryptionKey(){if(!this.encryptionInfo?.keyUrl)return null;try{console.log("\u{1F511} \u4E0B\u8F7D\u89E3\u5BC6\u5BC6\u94A5...");const{statusCode:u,body:e}=await $(this.encryptionInfo.keyUrl,{method:"GET",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"},headersTimeout:3e4,bodyTimeout:3e4});if(u===200){const t=[];for await(const o of e)t.push(o);const n=Buffer.concat(t);return console.log(`\u2705 \u5BC6\u94A5\u4E0B\u8F7D\u6210\u529F (${n.length} bytes)`),n}}catch(u){console.error(`\u274C \u5BC6\u94A5\u4E0B\u8F7D\u5931\u8D25: ${u.message}`)}return null}async decryptTSData(u,e){if(this.encryptionInfo?.method!=="AES-128")return u;try{const t=await import("crypto");let n;this.encryptionInfo.iv?n=Buffer.from(this.encryptionInfo.iv,"hex"):n=Buffer.alloc(16,0);const o=t.createDecipheriv("aes-128-cbc",e,n);return Buffer.concat([o.update(u),o.final()])}catch(t){return console.error(`\u274C \u89E3\u5BC6\u5931\u8D25: ${t.message}`),u}}parseFromFile(u){try{const e=l.readFileSync(u,"utf8");return this.parseM3U8Content(e)}catch(e){return console.error(`\u274C \u8BFB\u53D6\u6587\u4EF6\u5931\u8D25: ${e.message}`),[]}}parseFromString(u){return this.parseM3U8Content(u)}showStatistics(){console.log("\u{1F4CA} \u89E3\u6790\u7EDF\u8BA1\u4FE1\u606F"),console.log("================"),console.log(`\u603B\u7247\u6BB5\u6570\u91CF: ${this.links.length}`),console.log(`\u603B\u65F6\u957F: ${this.formatDuration(this.totalDuration)}`),console.log(`\u5E73\u5747\u7247\u6BB5\u65F6\u957F: ${(this.totalDuration/this.links.length).toFixed(2)} \u79D2`),console.log("")}formatDuration(u){const e=Math.floor(u/3600),t=Math.floor(u%3600/60),n=Math.floor(u%60);return e>0?`${e}:${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`:`${t}:${n.toString().padStart(2,"0")}`}exportLinks(u){try{let e="";e=this.links.map(t=>t.url).join(`
`),l.writeFileSync(u,e,"utf8"),console.log(`\u2705 \u94FE\u63A5\u5DF2\u5BFC\u51FA\u5230: ${u}`)}catch(e){console.error(`\u274C \u5BFC\u51FA\u5931\u8D25: ${e.message}`)}}printAllLinks(u=!1){console.log("\u{1F517} \u63D0\u53D6\u5230\u7684\u89C6\u9891\u7247\u6BB5\u94FE\u63A5"),console.log("=========================="),this.links.forEach((e,t)=>{u?(console.log(`[${e.index}] \u65F6\u957F: ${e.duration}s`),console.log(`URL: ${e.url}`),console.log("---")):console.log(e.url)})}checkFFmpeg(){try{return S.sync("ffmpeg",["-version"],{encoding:"utf8"}).status===0?(console.log("\u2705 FFmpeg \u53EF\u7528"),!0):(console.error("\u274C FFmpeg \u4E0D\u53EF\u7528\uFF0C\u8BF7\u5B89\u88C5 FFmpeg"),!1)}catch{return console.error("\u274C FFmpeg \u4E0D\u53EF\u7528\uFF0C\u8BF7\u5B89\u88C5 FFmpeg"),!1}}createFileList(u,e){const t=y.join(u,"filelist.txt");let n="";const o=e.filter(r=>r.success).sort((r,c)=>r.index-c.index);return o.forEach(r=>{n+=`file '${r.fileName}'
`}),l.writeFileSync(t,n,"utf8"),console.log(`\u{1F4DD} \u6587\u4EF6\u5217\u8868\u5DF2\u521B\u5EFA: ${t} (${o.length} \u4E2A\u6587\u4EF6)`),t}async downloadWithUndici(u,e,t,n=3,o){const r=`segment_${e.toString().padStart(6,"0")}.ts`,c=y.join(t,r),i=Date.now();for(let s=1;s<=n;s++)try{const{statusCode:d,body:h}=await $(u.url,{method:"GET",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"*/*","Accept-Language":"en-US,en;q=0.9","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive","Cache-Control":"no-cache",Pragma:"no-cache"},headersTimeout:3e4,bodyTimeout:12e4});if(d===200){const C=[];for await(const E of h)C.push(E);const g=Buffer.concat(C);let B=g;o&&this.encryptionInfo?.method==="AES-128"&&(B=await this.decryptTSData(g,o)),l.writeFileSync(c,B);const D=l.statSync(c);if(D.size>0){const E=Date.now()-i;return{index:e,success:!0,fileName:r,bytesDownloaded:D.size,duration:E}}}throw new Error(`HTTP ${d}`)}catch(d){try{l.existsSync(c)&&l.unlinkSync(c)}catch{}if(s===n){const C=Date.now()-i;return{index:e,success:!1,fileName:r,error:`undici\u4E0B\u8F7D\u5931\u8D25: ${d.message}`,duration:C}}const h=Math.min(1e3*Math.pow(2,s-1),5e3);await new Promise(C=>setTimeout(C,h))}return{index:e,success:!1,fileName:r,error:"\u672A\u77E5\u9519\u8BEF",duration:Date.now()-i}}downloadWithCurl(u,e,t,n=3,o){return new Promise(r=>{const c=`segment_${e.toString().padStart(6,"0")}.ts`,i=y.join(t,c),s=Date.now(),d=async h=>{const C=["-L","-o",i,"--connect-timeout","10","--max-time","120","--retry","0","--speed-time","30","--speed-limit","512","--compressed","--tcp-nodelay","--keepalive-time","60","--location","--fail","--silent","--show-error","--user-agent","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","--header","Accept: */*","--header","Accept-Language: en-US,en;q=0.9","--header","Accept-Encoding: gzip, deflate, br","--header","Connection: keep-alive","--header","Cache-Control: no-cache",u.url];let g=!1;const B=setTimeout(()=>{g=!0,D.kill("SIGTERM")},12e4),D=S("curl",C,{encoding:"utf8",stdio:["ignore","pipe","pipe"]});D.on("close",async E=>{clearTimeout(B);const m=Date.now()-s;if(!g&&E===0&&l.existsSync(i)){const F=l.statSync(i);if(F.size>0){if(o&&this.encryptionInfo?.method==="AES-128")try{const a=l.readFileSync(i),p=await this.decryptTSData(a,o);l.writeFileSync(i,p)}catch(a){console.error(`\u274C \u89E3\u5BC6\u5931\u8D25: ${a.message}`)}r({index:e,success:!0,fileName:c,bytesDownloaded:F.size,duration:m});return}}try{l.existsSync(i)&&l.unlinkSync(i)}catch{}if(h<n){const F=Math.min(1e3*Math.pow(2,h-1),5e3);setTimeout(()=>d(h+1),F)}else r({index:e,success:!1,fileName:c,error:`curl\u4E0B\u8F7D\u5931\u8D25 (code: ${E}, \u8017\u65F6: ${m}ms)`,duration:m})}),D.on("error",E=>{clearTimeout(B);const m=Date.now()-s;if(h<n){const F=Math.min(1e3*Math.pow(2,h-1),5e3);setTimeout(()=>d(h+1),F)}else r({index:e,success:!1,fileName:c,error:`curl\u8FDB\u7A0B\u9519\u8BEF: ${E.message}`,duration:m})})};d(1)})}async selectOptimalDownloadMethod(u){if(this.links.length===0)return"undici";const e=Math.min(3,this.links.length),t=this.links.slice(0,e);console.log("\u{1F9EA} \u6B63\u5728\u6D4B\u8BD5\u6700\u4F18\u4E0B\u8F7D\u65B9\u6CD5...");const n=Date.now();let o=0;try{const c=t.map((i,s)=>this.downloadWithUndici(i,s,u,1));o=(await Promise.allSettled(c)).filter(i=>i.status==="fulfilled"&&i.value.success).length}catch{}const r=Date.now()-n;try{for(let c=0;c<e;c++){const i=y.join(u,`segment_${c.toString().padStart(6,"0")}.ts`);l.existsSync(i)&&l.unlinkSync(i)}}catch{}return o/e>=.8&&r<15e3?(console.log("\u2705 \u9009\u62E9 undici \u65B9\u6CD5 (\u9AD8\u6027\u80FD)"),"undici"):(console.log("\u2705 \u9009\u62E9 curl \u65B9\u6CD5 (\u7A33\u5B9A\u6027\u4F18\u5148)"),"curl")}downloadSingleSegment(u,e,t,n=3,o){return this.downloadMethod==="undici"?this.downloadWithUndici(u,e,t,n,o):this.downloadWithCurl(u,e,t,n,o)}adjustConcurrency(u,e,t){return u>.95&&e>2?Math.min(t+3,30):u<.8||e<.5?Math.max(t-2,5):t}async downloadSegmentsConcurrent(u,e=20,t=3,n="auto",o){l.ensureDirSync(u);let r;this.encryptionInfo?.method==="AES-128"&&(r=await this.downloadDecryptionKey(),r||console.warn("\u26A0\uFE0F \u65E0\u6CD5\u4E0B\u8F7D\u89E3\u5BC6\u5BC6\u94A5\uFF0C\u5C06\u5C1D\u8BD5\u4E0D\u89E3\u5BC6\u4E0B\u8F7D")),n==="auto"?this.downloadMethod=await this.selectOptimalDownloadMethod(u):this.downloadMethod=n,console.log(`\u{1F4E5} \u5F00\u59CB\u9AD8\u901F\u5E76\u884C\u4E0B\u8F7D (\u65B9\u6CD5: ${this.downloadMethod}, \u5E76\u53D1\u6570: ${e})...`);const c=T(e),i=[],s={completed:0,successCount:0,failCount:0,totalBytes:0,currentConcurrency:e},d=Date.now(),h=()=>{const m=(Date.now()-d)/1e3,F=parseFloat((s.completed/this.links.length*100).toFixed(1)),a=s.completed/m||0,p=a>0?Math.floor((this.links.length-s.completed)/a):0,w=s.completed>0?s.successCount/s.completed:0,k=(s.totalBytes/1024/1024).toFixed(1);console.log(`\u{1F4CA} \u8FDB\u5EA6: ${s.completed}/${this.links.length} (${F}%) | \u6210\u529F\u7387: ${(w*100).toFixed(1)}% | \u901F\u5EA6: ${a.toFixed(1)}/s | \u5DF2\u4E0B\u8F7D: ${k}MB | ETA: ${p}s`),o&&o({completed:s.completed,total:this.links.length,percent:F,successCount:s.successCount,failCount:s.failCount,totalBytes:s.totalBytes,speed:a,eta:p,successRate:w});const M=this.adjustConcurrency(w,a,s.currentConcurrency);M!==s.currentConcurrency&&(s.currentConcurrency=M,console.log(`\u{1F504} \u8C03\u6574\u5E76\u53D1\u6570\u4E3A: ${s.currentConcurrency}`),c.concurrency=s.currentConcurrency)},C=setInterval(h,2e3);try{const m=this.links.map((F,a)=>c(()=>this.downloadSingleSegment(F,a,u,t,r)).then(p=>(s.completed++,p.success?(s.successCount++,p.bytesDownloaded&&(s.totalBytes+=p.bytesDownloaded)):(s.failCount++,s.failCount%5===0&&s.currentConcurrency>5&&(s.currentConcurrency=Math.max(s.currentConcurrency-2,5),c.concurrency=s.currentConcurrency,console.log(`\u26A0\uFE0F \u68C0\u6D4B\u5230\u8FDE\u7EED\u5931\u8D25\uFF0C\u964D\u4F4E\u5E76\u53D1\u6570\u4E3A: ${s.currentConcurrency}`))),h(),p)).catch(p=>({index:a,success:!1,fileName:`segment_${a.toString().padStart(6,"0")}.ts`,error:p.message,duration:0})));(await Promise.allSettled(m)).forEach((F,a)=>{F.status==="fulfilled"?i.push(F.value):i.push({index:a,success:!1,fileName:`segment_${a.toString().padStart(6,"0")}.ts`,error:F.reason?.message||"\u672A\u77E5\u9519\u8BEF"})})}finally{clearInterval(C)}const g=Math.floor((Date.now()-d)/1e3),B=(s.successCount/this.links.length*100).toFixed(1),D=(s.successCount/g).toFixed(1),E=(s.totalBytes/1024/1024).toFixed(1);return console.log(`
\u{1F4CA} \u4E0B\u8F7D\u5B8C\u6210! \u6210\u529F: ${s.successCount}, \u5931\u8D25: ${s.failCount}, \u603B\u8017\u65F6: ${g}s`),console.log(`\u{1F4C8} \u6210\u529F\u7387: ${B}%, \u5E73\u5747\u901F\u5EA6: ${D}/s, \u603B\u4E0B\u8F7D: ${E}MB`),parseFloat(B)<90&&console.log("\u{1F4A1} \u5EFA\u8BAE: \u5931\u8D25\u7387\u8F83\u9AD8\uFF0C\u53EF\u5C1D\u8BD5\u964D\u4F4E\u5E76\u53D1\u6570\u6216\u66F4\u6362\u4E0B\u8F7D\u65B9\u6CD5"),i}async mergeVideos(u){if(!this.checkFFmpeg())return!1;if(this.links.length===0)return console.error("\u274C \u6CA1\u6709\u53EF\u5408\u5E76\u7684\u89C6\u9891\u7247\u6BB5"),!1;try{console.log("\u{1F504} \u5F00\u59CB\u5408\u5E76\u89C6\u9891\u7247\u6BB5..."),l.ensureDirSync(u.tempDir),console.log("\u6B65\u9AA4 1: \u5E76\u884C\u4E0B\u8F7D\u89C6\u9891\u7247\u6BB5");const e=await this.downloadSegmentsConcurrent(u.tempDir,u.maxConcurrent||20,u.retryCount||3,u.downloadMethod||"auto",u.progressCallback),t=e.filter(c=>c.success);if(t.length===0)return console.error("\u274C \u6CA1\u6709\u6210\u529F\u4E0B\u8F7D\u7684\u7247\u6BB5"),!1;t.length<e.length&&console.warn(`\u26A0\uFE0F \u8B66\u544A: ${e.length-t.length} \u4E2A\u7247\u6BB5\u4E0B\u8F7D\u5931\u8D25\uFF0C\u5C06\u8DF3\u8FC7\u8FD9\u4E9B\u7247\u6BB5`),console.log("\u6B65\u9AA4 2: \u521B\u5EFA\u6587\u4EF6\u5217\u8868");const n=this.createFileList(u.tempDir,e);console.log("\u6B65\u9AA4 3: \u5408\u5E76\u89C6\u9891\u6587\u4EF6");const o=["-f","concat","-safe","0","-i",n];u.videoCodec==="copy"&&u.audioCodec==="copy"?o.push("-c","copy"):(u.videoCodec&&o.push("-c:v",u.videoCodec),u.audioCodec&&o.push("-c:a",u.audioCodec),u.quality&&o.push("-crf",u.quality)),o.push("-y"),o.push(u.outputPath),console.log("\u{1F680} \u6267\u884C FFmpeg \u547D\u4EE4:",`ffmpeg ${o.join(" ")}`);const r=S.sync("ffmpeg",o,{encoding:"utf8",stdio:["pipe","pipe","pipe"],cwd:u.tempDir});if(r.status===0){if(console.log("\u2705 \u89C6\u9891\u5408\u5E76\u6210\u529F!"),console.log(`\u{1F4F9} \u8F93\u51FA\u6587\u4EF6: ${u.outputPath}`),l.existsSync(u.outputPath)){const c=l.statSync(u.outputPath);console.log(`\u{1F4CA} \u6587\u4EF6\u5927\u5C0F: ${(c.size/1024/1024).toFixed(2)} MB`)}return u.keepTempFiles||(console.log("\u{1F9F9} \u6E05\u7406\u4E34\u65F6\u6587\u4EF6..."),l.removeSync(u.tempDir)),!0}else return console.error("\u274C FFmpeg \u6267\u884C\u5931\u8D25"),console.error("\u9519\u8BEF\u8F93\u51FA:",r.stderr),!1}catch(e){return console.error(`\u274C \u5408\u5E76\u8FC7\u7A0B\u53D1\u751F\u9519\u8BEF: ${e.message}`),!1}}async processM3U8ToVideo(u,e="./temp_segments",t={}){const n={outputPath:u,tempDir:e,keepTempFiles:!1,videoCodec:"copy",audioCodec:"copy",maxConcurrent:20,retryCount:3,downloadMethod:"auto",...t};return this.mergeVideos(n)}async processFileToVideo(u,e,t="./temp_segments",n={}){let o;try{o=l.readFileSync(u,"utf8")}catch(c){return console.error(`\u274C \u8BFB\u53D6 m3u8 \u6587\u4EF6\u5931\u8D25: ${c.message}`),!1}if(this.parseFromString(o).length===0)return console.error("\u274C \u6CA1\u6709\u627E\u5230\u4EFB\u4F55\u94FE\u63A5"),!1;this.showStatistics(),l.ensureDirSync(y.dirname(e));const r=await this.processM3U8ToVideo(e,t,n);return console.log(r?`
\u{1F389} \u89C6\u9891\u5904\u7406\u5B8C\u6210\uFF01`:`
\u{1F61E} \u89C6\u9891\u5904\u7406\u5931\u8D25`),r}async processUrlToVideo(u,e,t="./temp_segments",n={}){console.log("\u{1F310} \u4ECE\u7F51\u7EDC\u4E0B\u8F7D M3U8 \u6587\u4EF6...");try{const{statusCode:o,body:r}=await $(u,{method:"GET",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"*/*","Accept-Language":"en-US,en;q=0.9,zh-CN;q=0.8","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive","Cache-Control":"no-cache",Pragma:"no-cache","Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"cross-site",Referer:new URL(u).origin},headersTimeout:3e4,bodyTimeout:6e4,maxRedirections:5});if(o!==200)return console.error(`\u274C \u4E0B\u8F7D M3U8 \u6587\u4EF6\u5931\u8D25\uFF0C\u72B6\u6001\u7801: ${o}`),console.log("\u{1F4A1} \u5EFA\u8BAE: \u68C0\u67E5URL\u662F\u5426\u6709\u6548\uFF0C\u6216\u5C1D\u8BD5\u4F7F\u7528\u5176\u4ED6\u5DE5\u5177\u9A8C\u8BC1URL\u53EF\u8BBF\u95EE\u6027"),!1;const c=[];for await(const d of r)c.push(d);const i=Buffer.concat(c).toString("utf8");if(console.log("\u2705 M3U8 \u6587\u4EF6\u4E0B\u8F7D\u6210\u529F"),!i.includes("#EXTM3U")&&!i.includes("#EXT-X-VERSION"))return console.error("\u274C \u4E0B\u8F7D\u7684\u5185\u5BB9\u4E0D\u662F\u6709\u6548\u7684 M3U8 \u6587\u4EF6"),console.log("\u{1F4C4} \u6587\u4EF6\u5185\u5BB9\u9884\u89C8:",i.substring(0,200)),!1;if(this.parseFromString(i).length===0)return console.error("\u274C \u6CA1\u6709\u627E\u5230\u4EFB\u4F55\u89C6\u9891\u7247\u6BB5\u94FE\u63A5"),console.log("\u{1F4C4} M3U8 \u5185\u5BB9:",i),!1;this.showStatistics(),l.ensureDirSync(y.dirname(e));const s=await this.processM3U8ToVideo(e,t,n);return console.log(s?`
\u{1F389} \u89C6\u9891\u5904\u7406\u5B8C\u6210\uFF01`:`
\u{1F61E} \u89C6\u9891\u5904\u7406\u5931\u8D25`),s}catch(o){return console.error(`\u274C \u4E0B\u8F7D M3U8 \u6587\u4EF6\u5931\u8D25: ${o.message}`),console.log(`\u{1F4A1} \u5EFA\u8BAE:
      1. \u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5
      2. \u9A8C\u8BC1 URL \u662F\u5426\u6B63\u786E\u548C\u6709\u6548
      3. \u67D0\u4E9B M3U8 \u53EF\u80FD\u9700\u8981\u7279\u6B8A\u7684\u8BBF\u95EE\u6743\u9650\u6216 Token
      4. \u5C1D\u8BD5\u5728\u6D4F\u89C8\u5668\u4E2D\u76F4\u63A5\u8BBF\u95EE\u8BE5 URL`),!1}}}export{v as default};
