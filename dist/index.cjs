"use strict";const d=require("cross-spawn"),c=require("fs-extra"),p=require("path");function _interopDefaultCompat(l){return l&&typeof l=="object"&&"default"in l?l.default:l}const d__default=_interopDefaultCompat(d),c__default=_interopDefaultCompat(c),p__default=_interopDefaultCompat(p);var S=Object.defineProperty,k=(l,u,o)=>u in l?S(l,u,{enumerable:!0,configurable:!0,writable:!0,value:o}):l[u]=o,h=(l,u,o)=>(k(l,typeof u!="symbol"?u+"":u,o),o);class w{constructor(){h(this,"links"),h(this,"totalDuration"),this.links=[],this.totalDuration=0}parseM3U8Content(u){const o=u.split(`
`).map(e=>e.trim()).filter(e=>e);let s=0;console.log(`\u{1F3AC} \u5F00\u59CB\u89E3\u6790 M3U8 \u6587\u4EF6...
`);for(let e=0;e<o.length;e++){const t=o[e];if(t.startsWith("#EXTINF:")){const n=t.match(/#EXTINF:([\d.]+)/);n&&(s=parseFloat(n[1]))}else!t.startsWith("#")&&t.includes("http")&&(this.links.push({index:this.links.length+1,url:t,duration:s}),this.totalDuration+=s,s=0)}return this.links}parseFromFile(u){try{const o=c__default.readFileSync(u,"utf8");return this.parseM3U8Content(o)}catch(o){return console.error(`\u274C \u8BFB\u53D6\u6587\u4EF6\u5931\u8D25: ${o.message}`),[]}}parseFromString(u){return this.parseM3U8Content(u)}showStatistics(){console.log("\u{1F4CA} \u89E3\u6790\u7EDF\u8BA1\u4FE1\u606F"),console.log("================"),console.log(`\u603B\u7247\u6BB5\u6570\u91CF: ${this.links.length}`),console.log(`\u603B\u65F6\u957F: ${this.formatDuration(this.totalDuration)}`),console.log(`\u5E73\u5747\u7247\u6BB5\u65F6\u957F: ${(this.totalDuration/this.links.length).toFixed(2)} \u79D2`),console.log("")}formatDuration(u){const o=Math.floor(u/3600),s=Math.floor(u%3600/60),e=Math.floor(u%60);return o>0?`${o}:${s.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`:`${s}:${e.toString().padStart(2,"0")}`}exportLinks(u){try{let o="";o=this.links.map(s=>s.url).join(`
`),c__default.writeFileSync(u,o,"utf8"),console.log(`\u2705 \u94FE\u63A5\u5DF2\u5BFC\u51FA\u5230: ${u}`)}catch(o){console.error(`\u274C \u5BFC\u51FA\u5931\u8D25: ${o.message}`)}}printAllLinks(u=!1){console.log("\u{1F517} \u63D0\u53D6\u5230\u7684\u89C6\u9891\u7247\u6BB5\u94FE\u63A5"),console.log("=========================="),this.links.forEach((o,s)=>{u?(console.log(`[${o.index}] \u65F6\u957F: ${o.duration}s`),console.log(`URL: ${o.url}`),console.log("---")):console.log(o.url)})}checkFFmpeg(){try{return d__default.sync("ffmpeg",["-version"],{encoding:"utf8"}).status===0?(console.log("\u2705 FFmpeg \u53EF\u7528"),!0):(console.error("\u274C FFmpeg \u4E0D\u53EF\u7528\uFF0C\u8BF7\u5B89\u88C5 FFmpeg"),!1)}catch{return console.error("\u274C FFmpeg \u4E0D\u53EF\u7528\uFF0C\u8BF7\u5B89\u88C5 FFmpeg"),!1}}createFileList(u,o){const s=p__default.join(u,"filelist.txt");let e="";const t=o.filter(n=>n.success).sort((n,r)=>n.index-r.index);return t.forEach(n=>{e+=`file '${n.fileName}'
`}),c__default.writeFileSync(s,e,"utf8"),console.log(`\u{1F4DD} \u6587\u4EF6\u5217\u8868\u5DF2\u521B\u5EFA: ${s} (${t.length} \u4E2A\u6587\u4EF6)`),s}downloadSingleSegment(u,o,s,e=3){return new Promise(t=>{const n=`segment_${o.toString().padStart(4,"0")}.ts`,r=p__default.join(s,n),a=i=>{const g=d__default("curl",["-L","-o",r,"--connect-timeout","30","--max-time","300","--retry","2","--retry-delay","1","--silent","--show-error",u.url],{encoding:"utf8"});g.on("close",F=>{if(F===0&&c__default.existsSync(r)&&c__default.statSync(r).size>0){t({index:o,success:!0,fileName:n});return}i<e?(console.log(`\u26A0\uFE0F \u91CD\u8BD5\u4E0B\u8F7D\u7247\u6BB5 ${o+1} (\u5C1D\u8BD5 ${i+1}/${e})`),setTimeout(()=>a(i+1),1e3)):t({index:o,success:!1,fileName:n,error:`\u4E0B\u8F7D\u5931\u8D25\uFF0C\u5DF2\u91CD\u8BD5 ${e} \u6B21`})}),g.on("error",F=>{i<e?(console.log(`\u26A0\uFE0F \u91CD\u8BD5\u4E0B\u8F7D\u7247\u6BB5 ${o+1} (\u5C1D\u8BD5 ${i+1}/${e})`),setTimeout(()=>a(i+1),1e3)):t({index:o,success:!1,fileName:n,error:F.message})})};a(1)})}async downloadSegmentsConcurrent(u,o=10,s=3){console.log(`\u{1F4E5} \u5F00\u59CB\u5E76\u884C\u4E0B\u8F7D\u89C6\u9891\u7247\u6BB5 (\u5E76\u53D1\u6570: ${o})...`),c__default.ensureDirSync(u);const e=[];let t=0,n=0,r=0;const a=()=>{const i=(t/this.links.length*100).toFixed(1);console.log(`\u{1F4CA} \u4E0B\u8F7D\u8FDB\u5EA6: ${t}/${this.links.length} (${i}%) - \u6210\u529F: ${n}, \u5931\u8D25: ${r}`)};for(let i=0;i<this.links.length;i+=o){const g=this.links.slice(i,i+o).map((F,B)=>{const C=i+B;return this.downloadSingleSegment(F,C,u,s)});(await Promise.all(g)).forEach(F=>{e.push(F),t++,F.success?n++:(r++,console.log(`\u274C \u7247\u6BB5 ${F.index+1} \u4E0B\u8F7D\u5931\u8D25: ${F.error}`))}),a()}return console.log(`
\u{1F4CA} \u4E0B\u8F7D\u5B8C\u6210\u7EDF\u8BA1: \u6210\u529F ${n}, \u5931\u8D25 ${r}`),e}async mergeVideos(u){if(!this.checkFFmpeg())return!1;if(this.links.length===0)return console.error("\u274C \u6CA1\u6709\u53EF\u5408\u5E76\u7684\u89C6\u9891\u7247\u6BB5"),!1;try{console.log("\u{1F504} \u5F00\u59CB\u5408\u5E76\u89C6\u9891\u7247\u6BB5..."),c__default.ensureDirSync(u.tempDir),console.log("\u6B65\u9AA4 1: \u5E76\u884C\u4E0B\u8F7D\u89C6\u9891\u7247\u6BB5");const o=await this.downloadSegmentsConcurrent(u.tempDir,u.maxConcurrent||10,u.retryCount||3),s=o.filter(r=>r.success);if(s.length===0)return console.error("\u274C \u6CA1\u6709\u6210\u529F\u4E0B\u8F7D\u7684\u7247\u6BB5"),!1;s.length<o.length&&console.warn(`\u26A0\uFE0F \u8B66\u544A: ${o.length-s.length} \u4E2A\u7247\u6BB5\u4E0B\u8F7D\u5931\u8D25\uFF0C\u5C06\u8DF3\u8FC7\u8FD9\u4E9B\u7247\u6BB5`),console.log("\u6B65\u9AA4 2: \u521B\u5EFA\u6587\u4EF6\u5217\u8868");const e=this.createFileList(u.tempDir,o);console.log("\u6B65\u9AA4 3: \u5408\u5E76\u89C6\u9891\u6587\u4EF6");const t=["-f","concat","-safe","0","-i",e];u.videoCodec==="copy"&&u.audioCodec==="copy"?t.push("-c","copy"):(u.videoCodec&&t.push("-c:v",u.videoCodec),u.audioCodec&&t.push("-c:a",u.audioCodec),u.quality&&t.push("-crf",u.quality)),t.push("-y"),t.push(u.outputPath),console.log("\u{1F680} \u6267\u884C FFmpeg \u547D\u4EE4:",`ffmpeg ${t.join(" ")}`);const n=d__default.sync("ffmpeg",t,{encoding:"utf8",stdio:["pipe","pipe","pipe"],cwd:u.tempDir});if(n.status===0){if(console.log("\u2705 \u89C6\u9891\u5408\u5E76\u6210\u529F!"),console.log(`\u{1F4F9} \u8F93\u51FA\u6587\u4EF6: ${u.outputPath}`),c__default.existsSync(u.outputPath)){const r=c__default.statSync(u.outputPath);console.log(`\u{1F4CA} \u6587\u4EF6\u5927\u5C0F: ${(r.size/1024/1024).toFixed(2)} MB`)}return u.keepTempFiles||(console.log("\u{1F9F9} \u6E05\u7406\u4E34\u65F6\u6587\u4EF6..."),c__default.removeSync(u.tempDir)),!0}else return console.error("\u274C FFmpeg \u6267\u884C\u5931\u8D25"),console.error("\u9519\u8BEF\u8F93\u51FA:",n.stderr),!1}catch(o){return console.error(`\u274C \u5408\u5E76\u8FC7\u7A0B\u53D1\u751F\u9519\u8BEF: ${o.message}`),!1}}async processM3U8ToVideo(u,o="./temp_segments",s={}){const e={outputPath:u,tempDir:o,keepTempFiles:!1,videoCodec:"copy",audioCodec:"copy",maxConcurrent:10,retryCount:3,...s};return this.mergeVideos(e)}async processFileToVideo(u,o,s="./temp_segments",e={}){let t;try{t=c__default.readFileSync(u,"utf8")}catch(r){return console.error(`\u274C \u8BFB\u53D6 m3u8 \u6587\u4EF6\u5931\u8D25: ${r.message}`),!1}if(this.parseFromString(t).length===0)return console.error("\u274C \u6CA1\u6709\u627E\u5230\u4EFB\u4F55\u94FE\u63A5"),!1;this.showStatistics(),c__default.ensureDirSync(p__default.dirname(o));const n=await this.processM3U8ToVideo(o,s,e);return console.log(n?`
\u{1F389} \u89C6\u9891\u5904\u7406\u5B8C\u6210\uFF01`:`
\u{1F61E} \u89C6\u9891\u5904\u7406\u5931\u8D25`),n}}module.exports=w;
